---
title: "How to use the NetworkExtinction Package"
author: "M.Isidora Ávila-Thieme and Derek Corcoran"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: yes
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: biblio.bib

---
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
knitr::opts_chunk$set(fig.width=6, fig.height=4, message = FALSE) 
```

#Introduction

The objectives of the NetworkExtinction package is to analyze and visualize the topology of food-webs and its responses to the simulated extinction of species.

The main indexes used for these analyzes are: 

1. Number of nodes: Total number of species in the network [@dunne2002food].

2. Number of links: Number of trophic relationships represented in the food web [@dunne2002food].

3. Connectance: Proportion of all possible trophic links that are completed [@dunne2002food].

4. Primary removals: It occurs when the researcher intentionally removes one species, simulating a single extinction.

5. Secondary extinctions: A secondary extinction occurs when a non-basal species loses all of its prey items due to the removal of another species. In this context, basal species can experience primary removal, but not secondary extinctions [@dunne2002food].

6. Total extinctions: The sum of primary removal and secondary extinctions in one simulation.

This package was built with a total of six functions. There are four functions to analyze the cascading effect of extinctions in a food-web, one function to plot the results of any of the extinction analysis, and another to analize the degree distribution in the network.

Functions to analyze the cascading effect of extinctions are the following:

* *Mostconnected:* To simulate extinctions from the most connected species to less connected in the network.

* *ExtinctionOrder:* To simulate extinctions in a custom order.  

* *RandomExtinctions:* To develop a null hypothesis by generating random orders of simulated extinctions.

* *CompareExtinctions:* To compare the observed secondary extinctions with the expected secondary extinction generated by random extinction.


The function to plot results is:

* *ExtinctionPlot:* To plot the results of any of the extinction functions

The function to analize the degree distribution is:

* *degree_distribution:* To test if the degrees in the network follow a power law, exponential, or truncated distribution.



## How to install the package

```{r, eval=FALSE}
install.packages(NetworkExtinction)
library(NetworkExtinction)
```


## How to represent a food-web in R

NetworkExtinction package needs a representation of a food-web, by creating a Network object, using the network package [@butts2008network].

In order to create a network object you can start with a matrix or a edgelist object (for more details see network package).

### The network example

As an example of how to build a food-web we will explain how to create the network shown in figure 1.

![Figure 1. Food-web to be contructed in R](toymodel_trophic-network5.jpg) 


The network has ten nodes where each node represents one species. Here, four nodes are basal species (primary producers, from sp.1 to sp.4), three nodes are intermediate (primary consumers, from sp.5 to sp.7), and the remaining three are top predators (from sp.8 to sp.10).

### How to build a network using an interaction matrix

We show you how to build the matrix that represent throphic interactions (Figure 2). Here, columns represent the consumers and the rows the resources. Note that in the columns, the first four species have only zeros because they are not consumers

The matrix is binary, where:
1 represents a trophic interaction 
0 represents the absence of a trophic interaction. 


![Figure 2. Matrix representation of the food-web](matrix.jpg)

The following code is an example of how to build the matrix in figure 2 using R:

```{r}
a<- matrix(c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0),nrow=10, ncol=10)

a
```


Once the matrix is ready, you need to build a network object using the network package:

```{r}
library(network)
net <- as.network(a, loops = TRUE)
net
```


# Functions

## Extinctions functions 

### Extinctions from most to less conected species in the network

The function to do this analysis is called *Mostconnected*. This function sorts the species from the most connected node to the least connected node, using total degree. First, it removes the most connected node in the network, simulating its extinction, and calculates the topological indexes of the network and counts how many species have indegree 0 (secondary extinction), not considering primary producers. Then, it removes the nodes that were secondarily extinct in the previous step and recalculates which is the new most connected node. This step is repeated until the number of links in the network is zero [@sole2001complexity; @dunne2002food; @dunne2009cascading].

```{r, eval=FALSE}
library(NetworkExtinction)
data("net")
Mostconnected(Network = net)
```

```{r, echo=FALSE, message=FALSE}
library(NetworkExtinction)
data("net")
knitr::kable(Mostconnected(Network = net), caption = "Table 1: The resulting dataframe of the Mostconnected function")
```

The result of this function is the dataframe shown in table 1. The first column called *Spp* indicates the order in which the species were removed simulating an extinction. 

The column *Secondary_extinctions* represents the numbers of species that become extinct given that they do not have any food items left in the food-web, while the *AccSecondaryExtinction* column represents the accumulated secondary extinctions.

To plot the results, see function *ExtinctionPlot*

```{r, fig.cap="Figure 3. The graph shows the number of accumulated secondary extinctions that occur when removing species from the most to the least connected species"}
data("net")
history <- Mostconnected(Network = net)
ExtinctionPlot(History = history, Variable = "AccSecondaryExtinction")

```


### Extinctions using a custom order

The function to do this analysis is called *ExtinctionOrder*

It takes a network and extinguishes nodes using a custom order, then it calculates the topological network index and the secondary extinctions.

```{r, eval=FALSE}
data("net")
ExtinctionOrder(Network = net, Order = c(2,4,7))
```

```{r, echo=FALSE}
data("net")
knitr::kable(ExtinctionOrder(Network = net, Order = c(2,4,7))$DF, caption = "Table 2: The resulting dataframe of the ExtinctionOrder function")
```

```{r, echo=FALSE, fig.cap= "Figure 4. The graph shows the number of accumulated secondary extinctions that occur when removing species in a custom order. In this example species 2 is removed followed by 4 and lastly species 7 is removed"}
data("net")
ExtinctionOrder(Network = net, Order = c(2,4,7))$Graph
```

The results of this function are a dataframe with the topological index of the network in each extinction step (Table 2), and a plot that shows the number of accumulated secondary extinctions that occur with each removed node (Figure 4).

### Random extinction
The function to do this analysis is called *RandomExtinctions*
From a network, a certain amount of simulations is done (nsim), in which the species are removed in a random order.

the main of doing prymary removals randomly is to compare whether the number of secondary extinctions that occur when you remove nodes with a particular order (MostConnected or Extinctionorder) is different from the number of secondary extinctions that occur when executing primary removal orders in a random manner (To do this, see the function below *CompareExtinctions*).

```{r, message=FALSE}
data(net)
RandomExtinctions(Network= net, nsim= 50)
```

The result is a dataframe and a graph. 

*  In the dataframe,  The first column (NumExt) represents the number of extinction that occurs by primary removal. The second one, represents the deviation to the average of the accumulated secondary extinctions that occur when, independently of species identity, a certain number of species is extracted by primary removal. The third one, represents the average of the accumulated secondary extinctions that occur when, regardless of the specie identity, a certain number of species is extracted by primary removal.

*  In the graph, the figure shows the accumulated secondary extinction with their deviation (red shadow) that occur as the number of primary removal increases

###Comparison of Null hypothesis with other extinction histories

By using the *RandomExtincton* function, we create a null hypothesis for us to compare it with either an extinction history generated by the *ExtinctionOrder* function or the *Mostconnected* function. In order to compare the expected extinctions developed by our null hypothesis with the observed extinction history we developed the *CompareExtinctions* function.

The way to use this function is to first create the extinction history and the null hypothesis and then use the function to compare them:

```{r,message=FALSE, warning=FALSE}
data("net")
History <- ExtinctionOrder(Network = net, Order = c(1,2,3,4,5,6,7,8,9,10))

set.seed(2)
NullHyp <- RandomExtinctions(Network = net, nsim = 100)

Comparison <- CompareExtinctions(Nullmodel = NullHyp, Hypothesis = History)
```

the resulting object will have a graph with a dashed line showing the observed extinction history, and a solid line showing the expected value of secondary extinctions originated at random:

```{r}
Comparison$graph
```

We will also get a Test object which will show the goodness of fit statistics of the comparison:

```{r}
Comparison$Test
```

since the p value is `r round(Comparison$Test$p.value, 2)` which is larger than 0.05, we consider that the generated extinction history is significantly different than the null hypothesis.


## Plots of the extinctions history of a network function

The function to do this analysis is called *ExtinctionPlot*

It takes a NetworkTopology class object and plots the network index of interest after every extinction. By default, the function plot the numbers of accumulated secondary extinctions in function of each step of primary extinction.

```{r}
data(net)
history <- Mostconnected(Network = net)
ExtinctionPlot(History = history)

# To specify the variable to be ploted in the y axis, you need to
# add the name of the variable that you want plot
ExtinctionPlot(History = history, Variable = "LinksPerSpecies")

```


## Degree distribution function

The function to do this analysis is called *degree_distribution*

degree_distribution function calculate the cumulative distribution of the number of links that each species in the food network has [@estrada2007food]. Then, three expected distribution to the observed distribution, this are:
*  Exponential distribution model 
*  Power-law distribution model  
*  Truncated power-law distribution model  

At the same time, the degree_distribution function calculate the AIC to recognize among the three models mentioned above, which is the one that best fits to the observed distribution.

Finally, the degree_distribution function generate a plot of the observed degree distribution in a log-log scale fitting the three models mentioned above
```{r}
data("chilean_intertidal")
degree_distribution(chilean_intertidal, name = "Test")
```

The function generate three results:


1.  A list with the observed value of the network degree distribution (column K and Cumulative) and the expected values of the each fitting model (Exp = Exponential model, Power = Power-law model, truncated = Truncated Power-law model). k represent the degree of the network and cumulative the probability that each specie could be have this degree (pk).

2.  A list with the results if the AIC among the three models. In this case the model list are order from the best to the worst model.

3.  A Graph of the observed degree distribution with the fit of the three models.


The principal objective is to observe if the vulnerability of the network to the removal of the most connected species is related to their degree distribution.

The literature associated the degree distribution of the networks with the vulnerability of them to the removal of the most connected nodes. Networks that follow power law distribution are very vulnerable to the removal of the most connected nodes, while networks that follow exponential degree distribution are also very vulnerable to the removal of the most connected nodes, but not as much as for power law networks [see @albert2002statistical, @dunne2002food, @estrada2007food, @de2013topological].

*   OBSERVATION: In the graph, the zero values are not represented but this result are incorporate in the DDvalues result.

#Bibliography
